p8105\_hw6\_ph2538
================
Pei Yang Hsieh
2018-11-18

## Problem 1

### Tidying Data

Create a city\_state variable (e.g. “Baltimore, MD”), and a binary
variable indicating whether the homicide is solved. Omit cities Dallas,
TX; Phoenix, AZ; and Kansas City, MO – these don’t report victim race.
Also omit Tulsa, AL – this is a data entry mistake. Modifiy victim\_race
to have categories white and non-white, with white as the reference
category. Be sure that victim\_age is numeric.

``` r
homicide_data = read_csv(file = "./homicide-data.csv")
```

    ## Parsed with column specification:
    ## cols(
    ##   uid = col_character(),
    ##   reported_date = col_integer(),
    ##   victim_last = col_character(),
    ##   victim_first = col_character(),
    ##   victim_race = col_character(),
    ##   victim_age = col_character(),
    ##   victim_sex = col_character(),
    ##   city = col_character(),
    ##   state = col_character(),
    ##   lat = col_double(),
    ##   lon = col_double(),
    ##   disposition = col_character()
    ## )

``` r
#create city_state variable and omit certain cities
homicide_data =
  homicide_data %>% 
  mutate(city_state = str_c(city, ", ", state)) %>% 
  filter(city_state != "Dallas, TX", city_state != "Phoenix, AZ", city_state != "Kansas City, MO", city_state != "Tulsa, AL") 

#create binary variable
homicide_data = 
  homicide_data %>% 
  mutate(hom_solved = as.numeric(disposition == "Closed by arrest"))

#modify victim_race to binary category. Note that "Unknown" race is included in Non-white category.
homicide_data = 
  homicide_data %>% 
  mutate(victim_race = recode(victim_race, 'White' = "White", 'Hispanic' = "Non_white", 'Other' = "Non_white", 'Black' = "Non_white", 'Asian' = "Non_white", 'Unknown' = "Non_white")) %>% 
  mutate(victim_race = fct_relevel(victim_race, "White"))

#change victim_age to numeric
homicide_data = 
  homicide_data %>% 
  mutate(victim_age = as.numeric(victim_age))
```

    ## Warning in evalq(as.numeric(victim_age), <environment>): NAs introduced by
    ## coercion

### GLM on Baltimore, MD

For the city of Baltimore, MD, use the glm function to fit a logistic
regression with resolved vs unresolved as the outcome and victim age,
sex and race (as just defined) as predictors. Save the output of glm as
an R object; apply the broom::tidy to this object; and obtain the
estimate and confidence interval of the adjusted odds ratio for solving
homicides comparing nonwhite victims to white victims keeping all other
variables fixed.

``` r
Baltimore_df = 
  homicide_data %>% 
  filter(city_state == "Baltimore, MD") %>% 
  select(hom_solved, victim_age, victim_race, victim_sex)

Baltimore_glm = 
  Baltimore_df %>% 
  glm(hom_solved ~ victim_age + victim_race + victim_sex, data = ., family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>%
  mutate(conf.low = exp(estimate - (1.96 * std.error)), 
         conf.high = exp(estimate + (1.96 * std.error))) %>% 
  select(term, log_OR = estimate, OR, p.value, conf.low, conf.high) %>% 
  knitr::kable(digits = 3)

Baltimore_glm  
```

| term                   | log\_OR |    OR | p.value | conf.low | conf.high |
| :--------------------- | ------: | ----: | ------: | -------: | --------: |
| (Intercept)            |   1.186 | 3.274 |   0.000 |    2.067 |     5.186 |
| victim\_age            | \-0.007 | 0.993 |   0.032 |    0.987 |     0.999 |
| victim\_raceNon\_white | \-0.820 | 0.441 |   0.000 |    0.313 |     0.620 |
| victim\_sexMale        | \-0.888 | 0.412 |   0.000 |    0.315 |     0.537 |

### GLM on all cities

Now run glm for each of the cities in your dataset, and extract the
adjusted odds ratio (and CI) for solving homicides comparing black
victims to white victims. Do this within a “tidy” pipeline, making use
of purrr::map, list columns, and unnest as necessary to create a
dataframe with estimated ORs and CIs for each city.

``` r
all_cities_df = 
  homicide_data %>% 
  select(city_state, hom_solved, victim_age, victim_race, victim_sex)

all_cities_glm = 
  all_cities_df %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(model = map(data, ~glm(hom_solved ~ victim_age + victim_race + victim_sex, data = ., family = binomial())),
  model = map(model, broom::tidy)) %>% 
  select(-data) %>% 
  unnest() %>% 
  mutate(OR = exp(estimate)) %>%
  mutate(conf.low = exp(estimate - (1.96 * std.error)), 
         conf.high = exp(estimate + (1.96 * std.error))) %>% 
  select(city_state, term, log_OR = estimate, OR, p.value, conf.low, conf.high) %>% 
  filter(term != "victim_sexUnknown")

all_cities_glm
```

    ## # A tibble: 188 x 7
    ##    city_state    term            log_OR    OR   p.value conf.low conf.high
    ##    <chr>         <chr>            <dbl> <dbl>     <dbl>    <dbl>     <dbl>
    ##  1 Albuquerque,~ (Intercept)    1.23    3.43    1.31e-3    1.62      7.27 
    ##  2 Albuquerque,~ victim_age    -0.0230  0.977   1.08e-3    0.964     0.991
    ##  3 Albuquerque,~ victim_raceN~ -0.299   0.741   2.38e-1    0.451     1.22 
    ##  4 Albuquerque,~ victim_sexMa~  0.455   1.58    1.15e-1    0.895     2.77 
    ##  5 Atlanta, GA   (Intercept)    1.15    3.17    1.43e-3    1.56      6.43 
    ##  6 Atlanta, GA   victim_age    -0.0118  0.988   9.81e-3    0.979     0.997
    ##  7 Atlanta, GA   victim_raceN~ -0.284   0.753   3.17e-1    0.432     1.31 
    ##  8 Atlanta, GA   victim_sexMa~ -0.0101  0.990   9.58e-1    0.679     1.44 
    ##  9 Baltimore, MD (Intercept)    1.19    3.27    4.30e-7    2.07      5.19 
    ## 10 Baltimore, MD victim_age    -0.00699 0.993   3.22e-2    0.987     0.999
    ## # ... with 178 more rows

### Plot estimates and CIs on all cities

Create a plot that shows the estimated ORs and CIs for each city.
Organize cities according to estimated OR, and comment on the plot.

``` r
Plot_all_cities =
  all_cities_glm %>% 
  ggplot(aes(fct_reorder(city_state, OR), OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  labs(
    title = "Estimates and CIs for All Cities",
    x = "City",
    y = "Estimates"
  )  +
  theme(axis.text.x = element_text(angle = 90)) 

Plot_all_cities
```

## Problem 2

Load and clean the data for regression analysis (i.e. convert numeric to
factor where appropriate, check for missing data, etc.).

``` r
birthweight_data = read_csv(file = "./birthweight.csv")
```

    ## Parsed with column specification:
    ## cols(
    ##   .default = col_integer(),
    ##   gaweeks = col_double(),
    ##   ppbmi = col_double(),
    ##   smoken = col_double()
    ## )

    ## See spec(...) for full column specifications.

``` r
birthweight_data = 
  birthweight_data %>%
  mutate(babysex = as.factor(babysex), frace = as.factor(frace), malform = as.factor(malform), 
         mrace = as.factor(mrace))
```

### Build a model

Propose a regression model for birthweight. This model may be based on a
hypothesized structure for the factors that underly birthweight, on a
data-driven model-building process, or a combination of the two.
Describe your modeling process and show a plot of model residuals
against fitted values – use add\_predictions and add\_residuals in
making this plot.

``` r
mod_inc_mrace = 
  birthweight_data %>%
  select(bwt, fincome, mrace)

lm_inc_mrace = lm(bwt ~ fincome + mrace, mod_inc_mrace)

lm_inc_mrace %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 3)
```

| term        |  estimate | p.value |
| :---------- | --------: | ------: |
| (Intercept) |  3221.086 |   0.000 |
| fincome     |     0.836 |   0.007 |
| mrace2      | \-298.944 |   0.000 |
| mrace3      | \-117.732 |   0.118 |
| mrace4      | \-195.690 |   0.000 |

``` r
modelr::add_residuals(mod_inc_mrace, lm_inc_mrace)
```

    ## # A tibble: 4,342 x 4
    ##      bwt fincome mrace  resid
    ##    <int>   <int> <fct>  <dbl>
    ##  1  3629      35 1      379. 
    ##  2  3062      65 2       85.5
    ##  3  3345      85 1       52.9
    ##  4  3062      55 1     -205. 
    ##  5  3374       5 1      149. 
    ##  6  3374      55 1      107. 
    ##  7  2523      96 2     -479. 
    ##  8  2778       5 1     -447. 
    ##  9  3515      85 1      223. 
    ## 10  3459      75 2      474. 
    ## # ... with 4,332 more rows

``` r
modelr::add_predictions(mod_inc_mrace, lm_inc_mrace)
```

    ## # A tibble: 4,342 x 4
    ##      bwt fincome mrace  pred
    ##    <int>   <int> <fct> <dbl>
    ##  1  3629      35 1     3250.
    ##  2  3062      65 2     2976.
    ##  3  3345      85 1     3292.
    ##  4  3062      55 1     3267.
    ##  5  3374       5 1     3225.
    ##  6  3374      55 1     3267.
    ##  7  2523      96 2     3002.
    ##  8  2778       5 1     3225.
    ##  9  3515      85 1     3292.
    ## 10  3459      75 2     2985.
    ## # ... with 4,332 more rows

### Plot model

``` r
mod_inc_mrace %>% 
  modelr::add_residuals(lm_inc_mrace) %>% 
  ggplot(aes(x = mrace, y = resid)) + geom_violin()
```

![](p8105_hw6_ph2538_files/figure-gfm/unnamed-chunk-7-1.png)<!-- -->

``` r
mod_inc_mrace %>% 
  modelr::add_predictions(lm_inc_mrace) %>% 
  ggplot(aes(x = mrace, y = pred)) + geom_violin()
```

![](p8105_hw6_ph2538_files/figure-gfm/unnamed-chunk-8-1.png)<!-- -->

### Comparing models

Compare your model to two others: One using length at birth and
gestational age as predictors (main effects only) One using head
circumference, length, sex, and all interactions (including the
three-way interaction) between these

Make this comparison in terms of the cross-validated prediction error;
use crossv\_mc and functions in purrr as appropriate.

``` r
mod_len_age = 
  birthweight_data %>%
  select(bwt, blength, gaweeks)

lm_len_age = lm(bwt ~ blength + gaweeks, mod_len_age)

lm_len_age %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 3)
```

| term        |   estimate | p.value |
| :---------- | ---------: | ------: |
| (Intercept) | \-4347.667 |       0 |
| blength     |    128.556 |       0 |
| gaweeks     |     27.047 |       0 |

``` r
modelr::add_residuals(mod_len_age, lm_len_age)
```

    ## # A tibble: 4,342 x 4
    ##      bwt blength gaweeks  resid
    ##    <int>   <int>   <dbl>  <dbl>
    ##  1  3629      51    39.9  341. 
    ##  2  3062      48    25.9  538. 
    ##  3  3345      50    39.9  186. 
    ##  4  3062      52    40   -357. 
    ##  5  3374      52    41.6  -88.4
    ##  6  3374      52    40.7  -64.0
    ##  7  2523      46    40.3 -133. 
    ##  8  2778      49    37.4 -185. 
    ##  9  3515      52    40.3   87.8
    ## 10  3459      50    40.7  278. 
    ## # ... with 4,332 more rows

``` r
modelr::add_predictions(mod_len_age, lm_len_age)
```

    ## # A tibble: 4,342 x 4
    ##      bwt blength gaweeks  pred
    ##    <int>   <int>   <dbl> <dbl>
    ##  1  3629      51    39.9 3288.
    ##  2  3062      48    25.9 2524.
    ##  3  3345      50    39.9 3159.
    ##  4  3062      52    40   3419.
    ##  5  3374      52    41.6 3462.
    ##  6  3374      52    40.7 3438.
    ##  7  2523      46    40.3 2656.
    ##  8  2778      49    37.4 2963.
    ##  9  3515      52    40.3 3427.
    ## 10  3459      50    40.7 3181.
    ## # ... with 4,332 more rows

``` r
mod_hc_len_sex = 
  birthweight_data %>%
  select(bwt, bhead, blength, babysex)

lm_hc_len_sex = lm(bwt ~ bhead + blength + babysex, mod_hc_len_sex)

lm_hc_len_sex %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 3)
```

| term        |   estimate | p.value |
| :---------- | ---------: | ------: |
| (Intercept) | \-6121.391 |       0 |
| bhead       |    148.175 |       0 |
| blength     |     85.016 |       0 |
| babysex2    |     41.086 |       0 |

``` r
modelr::add_residuals(mod_hc_len_sex, lm_hc_len_sex)
```

    ## # A tibble: 4,342 x 5
    ##      bwt bhead blength babysex   resid
    ##    <int> <int>   <int> <fct>     <dbl>
    ##  1  3629    34      51 2        336.  
    ##  2  3062    34      48 1         64.7 
    ##  3  3345    36      50 2       -160.  
    ##  4  3062    34      52 1       -275.  
    ##  5  3374    34      52 2         -4.48
    ##  6  3374    33      52 1        185.  
    ##  7  2523    33      46 2       -197.  
    ##  8  2778    33      49 2       -197.  
    ##  9  3515    36      52 1       -119.  
    ## 10  3459    33      50 1        440.  
    ## # ... with 4,332 more rows

``` r
modelr::add_predictions(mod_hc_len_sex, lm_hc_len_sex)
```

    ## # A tibble: 4,342 x 5
    ##      bwt bhead blength babysex  pred
    ##    <int> <int>   <int> <fct>   <dbl>
    ##  1  3629    34      51 2       3293.
    ##  2  3062    34      48 1       2997.
    ##  3  3345    36      50 2       3505.
    ##  4  3062    34      52 1       3337.
    ##  5  3374    34      52 2       3378.
    ##  6  3374    33      52 1       3189.
    ##  7  2523    33      46 2       2720.
    ##  8  2778    33      49 2       2975.
    ##  9  3515    36      52 1       3634.
    ## 10  3459    33      50 1       3019.
    ## # ... with 4,332 more rows
